apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    cexpay.io/version: "ARG_RELEASE_VERSION"
    cexpay.io/ci.tag: "ARG_CI_TAG"
    cexpay.io/ci.job: "ARG_CI_JOB"
    cexpay.io/ci.pipeline: "ARG_CI_PIPELINE"
  name: ARG_JOB_NAME
  namespace: ARG_KUBE_NAMESPACE
spec:
  template:
    spec:
      containers:
        - name: "migration-database"
          image: "ARG_IMAGE:ARG_TAG"
          args: ["ARG_ACTION"]
          volumeMounts:
            - name: migration-secret-files
              mountPath: /etc/cexiolabs/migration/secrets
              readOnly: true
          env:
            - name: LOG_LEVEL
              value: trace
            - name: TARGET_VERSION
              value: ARG_TARGET_VERSION
      volumes:
        - name: migration-secret-files
          secret:
            secretName: ARG_TIMESTAMP-migration
      restartPolicy: Never
  backoffLimit: 5
  # The activeDeadlineSeconds applies to the duration of the job, no matter how many Pods are created.
  # Once a Job reaches activeDeadlineSeconds, all of its running Pods are terminated and
  #   the Job status will become type: Failed with reason: DeadlineExceeded.
  activeDeadlineSeconds: 600
