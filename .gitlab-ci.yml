variables:
  IMAGE_HELM2: alpine/helm:2.14.0
  # IMAGE_HELM3: harbor.infra.kube/infra/helm:3
  IMAGE_HELM3: devdocker.infra.kube/cexiolabs/docker/helm3/snapshot:master.dcb37861
  IMAGE_KUBECTL: bitnami/kubectl:1.20.2

.functions: &functions |
  function verify_runtime_version_helm2() {
    if [ -z "${CI_COMMIT_TAG}" ]; then
      echo "The function verify_runtime_version_helm3() is able to use for tags only. Variable CI_COMMIT_TAG is not set." >&2
      exit 127
    fi
    local EXPECTED_VERSION=$(echo "${CI_COMMIT_TAG}" | cut -d- -f1)
    local HELM_CHART_APP_VERSION=$(grep -e '^appVersion:' runtime/Chart.yaml | cut -d ':' -f 2 | tr -d '[:space:]')
    if [ "$HELM_CHART_APP_VERSION-runtime-helm2" != "$CI_COMMIT_TAG" ]; then
      echo "Helm Chart appVersion '${HELM_CHART_APP_VERSION}' is not same as tag version '${EXPECTED_VERSION}'. Your tag should named as '$HELM_CHART_APP_VERSION-runtime-helm2' for the case." >&2
      exit 255
    fi
  }
  function verify_runtime_version_helm3() {
    if [ -z "${CI_COMMIT_TAG}" ]; then
      echo "The function verify_runtime_version_helm3() is able to use for tags only. Variable CI_COMMIT_TAG is not set." >&2
      exit 127
    fi
    local EXPECTED_VERSION=$(echo "${CI_COMMIT_TAG}" | cut -d- -f1)
    local HELM_CHART_APP_VERSION=$(grep -e '^appVersion:' runtime/Chart.yaml | cut -d ':' -f 2 | tr -d '[:space:]')
    if [ "$HELM_CHART_APP_VERSION-runtime" != "$CI_COMMIT_TAG" ]; then
      echo "Helm Chart appVersion '${HELM_CHART_APP_VERSION}' is not same as tag version '${EXPECTED_VERSION}'. Your tag should named as '$HELM_CHART_APP_VERSION-runtime' for the case." >&2
      exit 255
    fi
  }
  function verify_migration_version() {
    if [ -z "${CI_COMMIT_TAG}" ]; then
      echo "The function verify_migration_version() is able to use for tags only. Variable CI_COMMIT_TAG is not set." >&2
      exit 127
    fi
    local EXPECTED_VERSION=$(echo "${CI_COMMIT_TAG}" | cut -d- -f1)
    local DATABASE_RELEASE_VERSION=$(grep -e '^RELEASE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    if [ "$DATABASE_RELEASE_VERSION-database" != "$CI_COMMIT_TAG" ]; then
      echo "Migration manifest RELEASE_TAG '${DATABASE_RELEASE_VERSION}' is not same as tag version '${EXPECTED_VERSION}'. Your tag should named as '$DATABASE_RELEASE_VERSION-database' for the case." >&2
      exit 255
    fi
  }
  function kube_config_setup() {
    if [ -z "${KUBECONF_BASE64}" ]; then
      echo "kube_deploy_dev_image() wrong arguments. Expected environment variable KUBECONF_BASE64" >&2
      exit 1
    fi
    mkdir -p ~/.kube
    echo "$KUBECONF_BASE64" | base64 -d > ~/.kube/config
  }

before_script:
  - *functions

stages:
  - deploy
  - rollback
  - delete

include:
  - local: /.gitlab-ci-infratest.yml

# HELM 3 Runtime deployment
1EVO:runtime:install:
  stage: deploy
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - ./runtime.scripts/download-configmaps-and-secrects.sh cexiopay-evolution-admin
    - cd runtime
    - helm --namespace "cexiopay-evolution" list
    - helm --namespace "cexiopay-evolution" upgrade --install --history-max 3 --values "values-base.yaml" --values "values.evolution.yaml" "blue" .
    - helm --namespace "cexiopay-evolution" history "blue" --max=3
  when: manual
  environment:
    name: evolution
    url: https://evolution-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

1EVO:runtime:rollback:
  stage: rollback
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay-evolution" list
    - helm --namespace "cexiopay-evolution" history "blue" --max=3
    - helm --namespace "cexiopay-evolution" rollback --recreate-pods "blue" 0
    - helm --namespace "cexiopay-evolution" history "blue" --max=3
  when: manual
  environment:
    name: evolution
    url: https://evolution-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

1EVO:runtime:delete:
  stage: delete
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay-evolution" list
    - helm --namespace "cexiopay-evolution" history "blue" --max=3
    - helm --namespace "cexiopay-evolution" uninstall  "blue"
  when: manual
  environment:
    name: evolution
    url: https://evolution-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

2PRSN:runtime:install:
  stage: deploy
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - ./runtime.scripts/download-configmaps-and-secrects.sh cexiopay-presentation-admin
    - cd runtime
    - helm --namespace "cexiopay-presentation" list
    - helm --namespace "cexiopay-presentation" upgrade --install --history-max 3 --values "values-base.yaml" --values "values.presentation.yaml" "blue" .
    - helm --namespace "cexiopay-presentation" history "blue" --max=3
  when: manual
  environment:
    name: presentation
    url: https://presentation-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

2PRSN:runtime:rollback:
  stage: rollback
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay-presentation" list
    - helm --namespace "cexiopay-presentation" history "blue" --max=3
    - helm --namespace "cexiopay-presentation" rollback --recreate-pods "blue" 0
    - helm --namespace "cexiopay-presentation" history "blue" --max=3
  when: manual
  environment:
    name: presentation
    url: https://presentation-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

2PRSN:runtime:delete:
  stage: delete
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay-presentation" list
    - helm --namespace "cexiopay-presentation" history "blue" --max=3
    - helm --namespace "cexiopay-presentation" uninstall  "blue"
  when: manual
  environment:
    name: presentation
    url: https://presentation-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

3TEST:blue:runtime:install:
  stage: deploy
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - ./runtime.scripts/download-configmaps-and-secrects.sh cexiopay-test-admin
    - cd runtime
    - helm --namespace "cexiopay-test" list
    - helm --namespace "cexiopay-test" upgrade --install --history-max 3 --values "values-base.yaml" --values "values.test.yaml" "blue" .
    - helm --namespace "cexiopay-test" history "blue" --max=3
  when: manual
  environment:
    name: test
    url: https://board.pay-cex-test.net/
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

3TEST:blue:board:install:
  stage: deploy
  image: 
    name: docker:20.10
  script:
    - apk add --no-cache git gnupg yq
    - DOCKER_IMAGE_REPOSITORY=$(yq eval '.application.board.serviceImage' runtime/values.test.yaml)
    - VERSION_TAG=$(yq eval '.application.board.tag' runtime/values-base.yaml)
    # Login to PROD registry
    - mkdir -p "/etc/docker/certs.d/$RELEASE_REGISTRY_HOST"
    - echo "${RELEASE_REGISTRY_CA}" > "/etc/docker/certs.d/${RELEASE_REGISTRY_HOST}/ca.crt"
    - echo "${RELEASE_REGISTRY_PASSWORD}" | docker login --username "${RELEASE_REGISTRY_USER}" --password-stdin "${RELEASE_REGISTRY_HOST}"
    # Cleanup
    - test -d .github-data && rm -rf .github-data
    # Checkout GitHub Pages repo
    - git clone "https://${GITHUB_LOGIN}:${GITHUB_TOKEN}@github.com/cexiolabs/cexiopay.board-test-hosting.git" .github-data
    # Remove old data
    - (cd .github-data && rm -rf * && git add -A)
    # Grab image content
    - IMAGE="${DOCKER_IMAGE_REPOSITORY}:${VERSION_TAG}"
    - echo "Create a container to grab content of image '${IMAGE}'"
    - docker pull "${IMAGE}"
    - CONTAINER_ID=$(docker create ${IMAGE})
    - docker cp "${CONTAINER_ID}:/usr/local/cexiolabs/cexiopay.board/." .github-data
    - docker rm -v "${CONTAINER_ID}"
    # - find .github-data/ -type f -exec sed -i "s~/PLACEHOLDER_BASE_PATH~~g" {} \;
    # - find .github-data/ -type f -exec sed -i "s~PLACEHOLDER_API_SERVICE_URL~${API_SERVICE_URL}~g" {} \;
    # - find .github-data/ -type f -exec sed -i "s~PLACEHOLDER_IDENTITY_SERVICE_URL~${IDENTITY_SERVICE_URL}~g" {} \;
    - echo -n "board.pay-cex-test.net" > .github-data/CNAME
    - touch .github-data/.nojekyll
    - (cd .github-data && git config --local user.name "${GITHUB_USER}" && git config --local user.email "${GITHUB_EMAIL}" && git add -A && git commit --amend --message "${VERSION_TAG}" && git push --force)
  when: manual
  environment:
    name: test
    url: https://pay-cex-test.net/
  # tags:
  #   - cexiolabs-github-pages
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

3TEST:green:runtime:install:
  stage: deploy
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - ./runtime.scripts/download-configmaps-and-secrects.sh cexiopay-test-admin
    - cd runtime
    - helm --namespace "cexiopay-test" list
    - helm --namespace "cexiopay-test" upgrade --install --history-max 3 --values "values-base.yaml" --values "values.test.yaml" "green" .
    - helm --namespace "cexiopay-test" history "green" --max=3
  when: manual
  environment:
    name: test
    url: https://board.pay-cex-test.net/
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

3TEST:blue:runtime:rollback:
  stage: rollback
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay-test" list
    - helm --namespace "cexiopay-test" history "blue" --max=3
    - helm --namespace "cexiopay-test" rollback --recreate-pods "blue" 0
    - helm --namespace "cexiopay-test" history "blue" --max=3
  when: manual
  environment:
    name: test
    url: https://board.pay-cex-test.net/
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

3TEST:blue:runtime:delete:
  stage: delete
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay-test" list
    - helm --namespace "cexiopay-test" history "blue" --max=3
    - helm --namespace "cexiopay-test" uninstall  "blue"
  when: manual
  environment:
    name: test
    url: https://board.pay-cex-test.net/
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

3TEST:green:runtime:delete:
  stage: delete
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay-test" list
    - helm --namespace "cexiopay-test" history "green" --max=3
    - helm --namespace "cexiopay-test" uninstall  "green"
  when: manual
  environment:
    name: test
    url: https://board.pay-cex-test.net/
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

4PROD:blue:runtime:install:
  stage: deploy
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - ./runtime.scripts/download-configmaps-and-secrects.sh cryptopay
    - cd runtime
    - helm --namespace "cexiopay" list
    - helm --namespace "cexiopay" upgrade --install --history-max 3 --values "values-base.yaml" --values "values.production.yaml" "blue" .
    - helm --namespace "cexiopay" history "blue" --max=3
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

4PROD:blue:board:install:
  stage: deploy
  image: 
    name: docker:20.10
  script:
    - apk add --no-cache git gnupg yq
    - DOCKER_IMAGE_REPOSITORY=$(yq eval '.application.board.serviceImage' runtime/values-base.yaml)
    - VERSION_TAG=$(yq eval '.application.board.tag' runtime/values-base.yaml)
    # Login to PROD registry
    - mkdir -p "/etc/docker/certs.d/$RELEASE_REGISTRY_HOST"
    - echo "${RELEASE_REGISTRY_CA}" > "/etc/docker/certs.d/${RELEASE_REGISTRY_HOST}/ca.crt"
    - echo "${RELEASE_REGISTRY_PASSWORD}" | docker login --username "${RELEASE_REGISTRY_USER}" --password-stdin "${RELEASE_REGISTRY_HOST}"
    # Cleanup
    - test -d .github-data && rm -rf .github-data
    # Checkout GitHub Pages repo
    - git clone "https://${GITHUB_LOGIN}:${GITHUB_TOKEN}@github.com/cexiolabs/cexiopay.board-production-hosting.git" .github-data
    # Remove old data
    - (cd .github-data && rm -rf * && git add -A)
    # Grab image content
    - IMAGE="${DOCKER_IMAGE_REPOSITORY}:${VERSION_TAG}"
    - echo "Create a container to grab content of image '${IMAGE}'"
    - docker pull "${IMAGE}"
    - CONTAINER_ID=$(docker create ${IMAGE})
    - docker cp "${CONTAINER_ID}:/usr/local/cexiolabs/cexiopay.board/." .github-data
    - docker rm -v "${CONTAINER_ID}"
    - echo -n "board.cexpay.io" > .github-data/CNAME
    - touch .github-data/.nojekyll
    - (cd .github-data && git config --local user.name "${GITHUB_USER}" && git config --local user.email "${GITHUB_EMAIL}" && git add -A && git commit --amend --message "${VERSION_TAG}" && git push --force)
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  # tags:
  #   - cexiolabs-github-pages
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

4PROD:blue:landing:install:
  stage: deploy
  image: 
    name: docker:20.10
  script:
    - apk add --no-cache git gnupg yq
    - DOCKER_IMAGE_REPOSITORY=$(yq eval '.application.landing.serviceImage' runtime/values-base.yaml)
    - VERSION_TAG=$(yq eval '.application.landing.tag' runtime/values-base.yaml)
    # Login to PROD registry
    - mkdir -p "/etc/docker/certs.d/$RELEASE_REGISTRY_HOST"
    - echo "${RELEASE_REGISTRY_CA}" > "/etc/docker/certs.d/${RELEASE_REGISTRY_HOST}/ca.crt"
    - echo "${RELEASE_REGISTRY_PASSWORD}" | docker login --username "${RELEASE_REGISTRY_USER}" --password-stdin "${RELEASE_REGISTRY_HOST}"
    # Cleanup
    - test -d .github-data && rm -rf .github-data
    # Checkout GitHub Pages repo
    - git clone "https://${GITHUB_LOGIN}:${GITHUB_TOKEN}@github.com/cexiolabs/cexiopay.landing-hosting.git" .github-data
    # Remove old data
    - (cd .github-data && rm -rf * && git add -A)
    # Grab image content
    - IMAGE="${DOCKER_IMAGE_REPOSITORY}:${VERSION_TAG}"
    - echo "Create a container to grab content of image '${IMAGE}'"
    - docker pull "${IMAGE}"
    - CONTAINER_ID=$(docker create ${IMAGE})
    - docker cp "${CONTAINER_ID}:/usr/local/cexiolabs/cexiopay.landing/." .github-data
    - docker rm -v "${CONTAINER_ID}"
    - find .github-data/ -type f -exec sed -i "s~/PLACEHOLDER_PATH_PREFIX~~g" {} \;
    - echo -n "cexpay.io" > .github-data/CNAME
    - touch .github-data/.nojekyll
    - (cd .github-data && git config --local user.name "${GITHUB_USER}" && git config --local user.email "${GITHUB_EMAIL}" && git add -A && git commit --amend --message "${VERSION_TAG}" && git push --force)
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  # tags:
  #   - cexiolabs-github-pages
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

4PROD:green:runtime:install:
  stage: deploy
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - ./runtime.scripts/download-configmaps-and-secrects.sh cryptopay
    - cd runtime
    - helm --namespace "cexiopay" list
    - helm --namespace "cexiopay" upgrade --install --history-max 3 --values "values-base.yaml" --values "values.production.yaml" "green" .
    - helm --namespace "cexiopay" history "green" --max=3
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

4PROD:blue:runtime:rollback:
  stage: rollback
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay" list
    - helm --namespace "cexiopay" history "blue" --max=3
    - helm --namespace "cexiopay" rollback --recreate-pods "blue" 0
    - helm --namespace "cexiopay" history "blue" --max=3
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

4PROD:blue:runtime:delete:
  stage: delete
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay" list
    - helm --namespace "cexiopay" history "blue" --max=3
    - helm --namespace "cexiopay" uninstall  "blue"
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/

4PROD:green:runtime:delete:
  stage: delete
  image:
    name: ${IMAGE_HELM3}
    entrypoint: [""]
  script:
    - verify_runtime_version_helm3
    - kube_config_setup
    - cd runtime
    - helm --namespace "cexiopay" list
    - helm --namespace "cexiopay" history "green" --max=3
    - helm --namespace "cexiopay" uninstall  "green"
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-runtime$/



#
#
# Database migration TAGs
#
#
1EVO:install:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: deploy
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - INSTALL_VERSION=$(grep -e '^INSTALL_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=evolution --kube-namespace=cexiopay-evolution --kube-admin-namespace=cexiopay-evolution-admin --image=harbor.infra.kube/cexiopay/database-evolution --tag="${DATABASE_IMAGE_TAG}" --target-version="${INSTALL_VERSION}" --install
  when: manual
  environment:
    name: evolution
    url: https://evolution-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/

1EVO:rollback:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: rollback
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - test -z "${ROLLBACK_VERSION}" && ROLLBACK_VERSION=$(grep -e '^ROLLBACK_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=evolution --kube-namespace=cexiopay-evolution --kube-admin-namespace=cexiopay-evolution-admin --image=harbor.infra.kube/cexiopay/database-evolution --tag="${DATABASE_IMAGE_TAG}" --target-version="${ROLLBACK_VERSION}" --rollback
  when: manual
  environment:
    name: evolution
    url: https://evolution-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/

2PRSN:install:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: deploy
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - INSTALL_VERSION=$(grep -e '^INSTALL_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=presentation --kube-namespace=cexiopay-presentation --kube-admin-namespace=cexiopay-presentation-admin --image=harbor.infra.kube/cexiopay/database-presentation --tag="${DATABASE_IMAGE_TAG}" --target-version="${INSTALL_VERSION}" --install
  when: manual
  environment:
    name: presentation
    url: https://presentation-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/

2PRSN:rollback:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: rollback
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - test -z "${ROLLBACK_VERSION}" && ROLLBACK_VERSION=$(grep -e '^ROLLBACK_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=presentation --kube-namespace=cexiopay-presentation --kube-admin-namespace=cexiopay-presentation-admin --image=harbor.infra.kube/cexiopay/database-presentation --tag="${DATABASE_IMAGE_TAG}" --target-version="${ROLLBACK_VERSION}" --rollback
  when: manual
  environment:
    name: presentation
    url: https://presentation-cexiopay.dev.kube
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/

3TEST:install:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: deploy
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - INSTALL_VERSION=$(grep -e '^INSTALL_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=test --kube-namespace=cexiopay-test --kube-admin-namespace=cexiopay-test-admin --image=harbor.infra.kube/cexiopay/database-test --tag="${DATABASE_IMAGE_TAG}" --target-version="${INSTALL_VERSION}" --install
  when: manual
  environment:
    name: test
    url: https://pay-cex-test.net
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/

3TEST:rollback:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: rollback
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - test -z "${ROLLBACK_VERSION}" && ROLLBACK_VERSION=$(grep -e '^ROLLBACK_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=test --kube-namespace=cexiopay-test --kube-admin-namespace=cexiopay-test-admin --image=harbor.infra.kube/cexiopay/database-test --tag="${DATABASE_IMAGE_TAG}" --target-version="${ROLLBACK_VERSION}" --rollback
  when: manual
  environment:
    name: test
    url: https://pay-cex-test.net
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/

4PROD:install:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: deploy
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - INSTALL_VERSION=$(grep -e '^INSTALL_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=prod --kube-namespace=cexiopay --kube-admin-namespace=cryptopay --image=harbor.infra.kube/cexiopay/database-production --tag="${DATABASE_IMAGE_TAG}" --target-version="${INSTALL_VERSION}" --install
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/

4PROD:rollback:db:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: rollback
  script:
    - verify_migration_version
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - DATABASE_IMAGE_TAG=$(grep -e '^DATABASE_IMAGE_TAG:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ROLLBACK_VERSION=$(grep -e '^ROLLBACK_VERSION:' migration/MANIFEST | cut -d ':' -f 2 | tr -d '[:space:]')
    - ./migration/migration-exec.sh --kube-context=prod --kube-namespace=cexiopay --kube-admin-namespace=cryptopay --image=harbor.infra.kube/cexiopay/database-production --tag="${DATABASE_IMAGE_TAG}" --target-version="${ROLLBACK_VERSION}" --rollback
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-database$/


#
#
# Install/sync admin config maps
#
#
4PROD:configmaps:
  image:
    name: ${IMAGE_KUBECTL}
    entrypoint: [""]
  stage: deploy
  script:
    - export KUBECONFIG=/tmp/.kube-config
    - echo "$KUBECONF_BASE64" | base64 -d > "${KUBECONFIG}"
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/gatehostinternal-envvars.yaml
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/gatehostinternal-files.yaml
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/messengerbridge-files.yaml
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/notifier-envvars.yaml
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/notifier-files.yaml
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/processing-envvars-setup.yaml
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/processing-envvars.yaml
    - kubectl --namespace cryptopay apply --filename=runtime.configmaps/production/processing-files.yaml
  when: manual
  environment:
    name: production
    url: https://cexpay.io/
  tags:
    - crtpdpl
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /-configmaps$/
